# Global options block
{
    # Use staging ACME CA if youâ€™re testing certs
    # acme_ca https://acme-staging-v02.api.letsencrypt.org/directory

    # Global logging settings
    debug                        # maximum verbosity for errors
    log {
        output stdout            # send all logs to Docker logs
        format json              # structured JSON logs
        level DEBUG              # capture everything (DEBUG+INFO+WARN+ERROR)
    }
}

# Web app
{$TALKIE_DOMAIN} {
    encode gzip

    # Remove Content-Security-Policy so we can test without CSP headers.
    header {
        -Content-Security-Policy
    }

    route {
        # Proxy Next.js build assets through a friendlier /static prefix to
        # avoid exposing /_next directly.
        handle_path /static/_next/* {
            uri strip_prefix /static
            reverse_proxy web:3000
        }

        reverse_proxy web:3000
    }

    # Access log for this site
    log {
        output stdout
        format json
        level DEBUG
    }
}

# API
{$API_TALKIE_DOMAIN} {
    header {
        -Content-Security-Policy
    }

    reverse_proxy api:3001

    log {
        output stdout
        format json
        level DEBUG
    }
}

# LiveKit WS/HTTP
{$LIVEKIT_TALKIE_DOMAIN} {
    header {
        -Content-Security-Policy
    }

    reverse_proxy livekit:7880

    log {
        output stdout
        format json
        level DEBUG
    }
}
